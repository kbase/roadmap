## Improvements to Metrics Service

### Summary

Better user metrics are frequently requested by KBase management and DOE, and are needed to improve user growth and retention. Improved user metrics will also be important to the success of the User Analytics Campaign.

This project seeks to improve the internal Metrics Service in terms of performance, reliability, maintainability, configurability, and available tools.


### Story/Description

The metrics service gathers data from KBase services, processes it, and makes it available primarily through a password protected web interface.

It has become an important tool for KBase internal management, DOE monitoring, quarterly and ad-hoc reporting, and even provides data for the production user interface.

However, as data size has grown in size and changed in shape, performance and reliability have suffered, and as requirements have evolved, new presentations, query, and system management requirements have surfaced.

This project seeks to improve the internal Metrics Service in terms of performance, reliability, maintainability, configurability, and available tools.

The Metrics Service consists of the following components:

1. service instrumentation and data recording
2. data harvesting
3. data preparation and normalization
4. user interface
5. data extraction
6. data presentation
7. public data

This project addresses components 2-6.

#### Existing Services

We currently have one set of scripts in control of data harvesting (2), running inside the kbase infrastructure since they require direct access to KBase databases.

The first version of the metrics service currently handles data preparation (3) as a nightly job and the user interface (4) through a customized Wordpress web site.

Data extraction (5) is provided by a new metrics service which is only used on-demand for reports. Data presentation (6) is provided by importing data extractions into a spreadsheet which has embedded charts and tables.

Public data is provided in the form of a set of json files which are generated by the data preparation scripts (3) and then copied to the production kbase-ui server by a separate process.

#### Improvements and New Services

Data harvesting does not need much additional work, other than simplification. For instance, the extraction of Splunk data has become very slow, but a replacement tool solves this problem. However, we cannot remove the Splunk data extraction because the existing user interface relies upon it.

The rest of the services, which are provided by two sets of scripts, one web site, and a spreadsheet, will be combined into one set of scripts and one web site.

The data preparation and normalization procedures have already been rewritten, but need additional work to support incremental database updating. (It currently must be built from scratch each time.)

The user interface and data presentation (for reports) are currently separate, but would be combined into a single data presentation user interface. The existing web components would be utilized, and additional ones built to replace those in the spreadsheet. Some components, such as the table of user accounts, would be much refactored and improved since the new backing data store is a relational database and not a set of files, and as such naturally provides fast filtering and ordering.

Data extraction already exists in the new metrics service in the form of a REST interface.

The public metrics data would continue to be provided in a similar manner, without an changes required for the ui.

#### Why Now?

Ongoing issues and inefficiencies are a drain on time and resources.

At present, the metrics data gathering process takes over 9 hours to run, which is is potentially affecting production resources (esp. database).

The existing user tools have suffered from performance issues (out of memory) and synchronization issues (due to failures of the data gathering scripts), which impacts staff time and efforts which seek to utilize this data.

### Implementation Notes for Sprint Planning

Usage metrics are currently utilized to assist KBase management and planning, and to communicate usage patterns to DOE and interested parties. To enable timely response to new and more complex requirements, the metrics system has been migrated to a more powerful architecture, and generally refactored to provide data through a generic web interface (REST). However, this new system requires manual operation whenever the metrics data needs to be refreshed prior to using it.

At present this new system is utilized for metrics charts prepared for quarterly and other reports. The chart data is extracted from the metrics system via a web api, and inserted into a spreadsheet in order to prepare graphs.

The internal metrics web site does not utilize the new system, rather relying on the previous generation metrics service.

The single usage of metrics on public-facing kbase services is the the histogram of narrative creation on the Dashboard. This is provided by a single file generated daily by the exiting metrics system. It is copied by another script, run hourly, into the production kbase-ui filesystem.  It would be better if this histogram were simply available at a metrics service, and could be requested on demand by the kbase-ui web app.

The purpose of this sprint would be to:

- automate the integration of data mined from kbase into the metrics system
- update or rewrite the internal metrics web site to utilize the new metrics system
- incorporate the additional charts for the quarterly and other reports into the internal metrics web site
- provide a simple service for providing metrics data to the kbase-ui web app
- document the system
- provide monitoring for the system

It needs to be automated, documented, and monitored. In addition, existing tools need to be migrated or rewritten to utilize the new service. This will save significant time when metrics output is needed, and allow a broader audience access to timely usage information. Availability of metrics output in compatible formats (e.g. csv) will continue to allow ad-hoc analysis.

The existing and replacement system are primarily coded in PHP. The existing system was originally just a presentation layer running as a Wordpress theme. It quickly grew, though, as the data needed preparation and normalization by a set of scripts run on the server. Since there was already a set of scripts and libraries for interfacing to Globus, Splunk, and solving data processing issues, it made sense to carry them over to the replacement system. Thus the new system is PHP based as well.

The new visualization layer will be more web-app based, with the PHP side serving mostly to prepare html documents to contain the web app, and to serve metrics data via a REST-like api. The visualization layer will be composed of javascript widget, which themselves will be supplied by third party libraries. We are presently using Highcharts for plots, but could switch to Plotly since it is used elsewhere at KBase and is open source.

Authentication is currently through Wordpress, but in the new system we will utilize the kbase ui codebase to provide normal kbase authentication, utilizing a whitelist of user accounts to provide authorization to access the metrics web app.

### User stories

KBase management and interested parties need to view and inspect a visualization of the following KBase user activity:
  - graphs of
    - cumulative new and return users
    - cumulative data stored
    - cumulative narratives created
    - daily and monthly active users
    - number of users combined with user engagement events
  - tables of
    - narrative access by name, date created, last saved, user, and # of accesses
    - method usage by name, author, date created, last access, # of embeds, # of requirements

KBase management and support staff needs to access a searchable database of existing users in order to look up a user for user support, e.g.:
  - determine if they have an accounts
  - find their email address in order to contact them
  - determine their sign up date
  - determine their last access date
  - determine their username based on their real name or email address

KBase management needs to provide simple graphs and charts of kbase usage to DOE and other interested parties in the form of graphs and tables embedded in reports.

KBase user interface needs to provide to users a histogram of narratives owned by users and shared with users as part of the user interface (dashboard).

KBase Staff using and maintaining the metrics system need to maintain a database which annotates user accounts with flags, in order to filter out internal, testing, and other users.

KBase Staff maintaining the metrics system receive alerts when it is not available or experience performance issues so that they may ensure it is available.

KBase staff maintaining the metrics system need to be able to update built in data sources, such as the mapping data or ip address to location translation data.

### Existing Issues

Generally we are generating metrics products on demand in response to the needs of some imminent report or meeting requirement. This has generated sets of ad-hoc procedures and tools which are difficult to repeat the next time they are needed. This increases our workload and decreases reliability of the data. T

 There is unnecessary difficulty ramping up to a new set of metrics output. This is due to changes in services, log formats, etc. which can both break the scripts which query kbase services for metrics data, and to those which analyze the resulting data stream. Changes like this also create additional work to integrate data from mutliple feeds into a single dataset.

In addition, many of the data sources are not designed with the metrics needs in mind. The data sources should should provide consistent labels, dates, measures, etc. which reflect the activity being monitored. Too often we have to resort to ad-hoc parsing and string matching to pull out the necessary information.

Existing issues in JIRA:

Reliability:
- On internal metric page cumulative narrative widget out of memory
  - https://atlassian.kbase.us/browse/KBASE-2976
- Filter out old narratives in metrics page
  - https://atlassian.kbase.us/browse/KBASE-1743
- Some internal users not being filtered from user metrics
  - https://atlassian.kbase.us/browse/KBASE-4099
- Update "is this person in KBase?" list for filtering user metrics
  - https://atlassian.kbase.us/browse/KBASE-3523    
- Updating Intranet graphs to sync in new data
  - https://atlassian.kbase.us/browse/KBASE-4095
- Revamp service logging to move away from syslog/splunk
  - https://atlassian.kbase.us/browse/KBASE-1562
- Dashboard Metrics widget can time out after 10s on a slow connection
  - https://atlassian.kbase.us/browse/KBASE-1734

The need for a consistent metrics program:
- Establish quarterly delivery to EC of user metrics
  - https://atlassian.kbase.us/browse/KBASE-2354
- Reach consensus with EC about which user metrics we want
  - https://atlassian.kbase.us/browse/KBASE-3502

New or improved data sources:
- Metrics for how many times a Narrative was opened
  - https://atlassian.kbase.us/browse/KBASE-2868
- Dynamic search usage metrics collection and analysis
  - https://atlassian.kbase.us/browse/SEARCH-98
- Summary of Data in KBase
  - https://atlassian.kbase.us/browse/KBASE-2070
- Add analytics to search pages
  - https://atlassian.kbase.us/browse/SEARCH-29
- Usage stats for methods and apps
  - https://atlassian.kbase.us/browse/KBASE-3372

### Timeline

One sprint with one staff member and a lot of coffee will be required to complete this project.

### Test plan

- data sources require descriptions and as best can be established a json schema so that they can be validated
- for data ingestion, unit tests based on sample data sources
- for data preparation and import, unit tests based on sample data ingestion products
- for metrics service, build database from set of sample data, test output from REST interface
- for user interface, simple ui testing


### Citations

Dependencies:
- php, python, perl
  - and related libraries
- postgresql
- highcharts (for internal vis), plotly (for internal or public vis)
